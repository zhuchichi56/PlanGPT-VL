import os
from typing import List, Dict, Any, Tuple, Optional
from loguru import logger
import fire
import random
import numpy as np
import torch
from utils import * 




PROMPTS = {
    "answer_direct": """你是一个城市规划专家。请观察图片并回答问题：

### 重要:
1. 回答必须基于图片内容。
2. 先观察图片整体内容和布局，分析关键要素，然后结合专业知识回答。
3. 回答应专业、清晰、准确。

问题：{question}""",


    "answer_with_caption": """你是一位资深城市规划专家。请基于图像内容回答城市规划相关问题。

### 重要:
1. 回答必须基于图片内容， 可适当参考图像描述信息。 
2. 首先观察图片整体内容和布局，分析关键要素，然后结合专业知识回答。
3. 回答应专业、清晰、准确。
4. 回答模仿如下风格（不参考内容，只参考风格）
eg1. 一圈、两屏、三区、四轴带。\n区包括：\n中部黑土地粮食主产区\n西部草原地农牧片区\n东部山地特色农业片区\n轴带包括：\n哈大先进制造业发展轴 （从哈尔滨到大连的发展轴线）\n开发开放经济带 （包括白城市、松原市等地区）\n长吉图门户发展轴 （从长春到图们江口岸的发展轴线）\n长松大白通长发展环线 （连接长春、松原、大安、白城、通榆等地的发展环线）\n"
eg2. 城镇开发边界与生态保护红线之间通常保持了一定的距离，避免了直接的冲突。然而，在某些区域，城镇开发边界与生态保护红线相邻，存在一定的潜在冲突。具体表现在：\n\n南京、苏州等经济发达地区 ：城镇开发边界与生态保护红线之间的距离较近，尤其是在城市近郊地区，城镇扩张的压力较大，可能会对生态保护红线内的区域产生威胁。\n沿海地区 ：城镇开发边界与海岸带生态保护红线之间的关系尤为重要，需要确保城镇开发不会对海洋生态系统造成破坏。"

问题：{question}
图像描述：{caption}""",

    "answer_direct_cpt": """你是一位资深城市规划专家。请基于图像内容回答城市规划相关问题。

### 重要:
1. 回答必须基于图片内容。
2. 首先观察图片整体内容和布局，分析关键要素，然后结合专业知识回答。
3. 将思考过程放在<think></think>中，将回答放在<summary></summary>中。
4. 思考过程应聚焦问题，采用关键点模式进行思考，整理成"作者提问的是xxx问题，为了解决上述问题我需要思考如下解决该问题的关键点：[1]xxxx, [2]xxxx, [3]xxxx"的格式。
5. 对每一个关键点，需要结合图像和问题写出具体的思考内容。
6. 回答应专业、清晰、准确。

### 示例1:
问题： 江苏省的国土空间布局呈现何种特征？

<think>
作者提问的是江苏省国土空间布局特征的问题，为了解决上述问题我需要思考如下解决该问题的关键点：
[1] 图例中各类空间要素的分布特点，包括耕地/永久基本农田（黄色区域）、生态保护红线（绿色区域）、城镇开发边界（红色区域）、水系（蓝色线条）和海域（浅蓝色区域）。
[2] 江苏省城镇开发区的空间分布特征，尤其是南部地区（苏南地区）与北部地区的差异对比，呈现"南密北疏"的特点。
[3] 生态保护红线的分布形态，主要沿江河湖泊呈带状或块状分布，形成集中与分散相结合的空间结构。
</think>

<summary>
布局呈现"南密北疏"特征：南部（如苏锡常都市圈）城镇开发边界密集，北部（如徐州、连云港）相对分散。生态保护红线沿江河湖泊呈带状或块状分布，形成集中与分散相结合的空间结构。
</summary>

### 示例2:
问题： 哈尔滨、长春、沈阳等省会城市周边的粮食安全带是否预留了足够的缓冲区，避免城市扩张侵蚀优质耕地？

<think>
作者提问的是省会城市周边粮食安全带缓冲区是否足够的问题，为了解决上述问题我需要思考如下解决该问题的关键点：
[1] 哈尔滨、长春、沈阳这三个省会城市周边的永久基本农田/粮食安全带分布情况，尤其关注其空间布局形态。
[2] 城市开发边界与粮食安全带之间的缓冲区宽度，包括哈尔滨周边（20-30公里）、长春周边（西北方向较宽，西侧和西南方向不足15公里）、沈阳周边（北部5-10公里）的具体情况。
[3] 根据缓冲区宽度评估其是否足够应对城市扩张压力，判断是否有城市侵蚀优质耕地的风险存在。
[4] 针对缓冲区不足的情况，可能的解决方案，包括优化城市增长边界、修复破碎化区域、建立动态监测机制等。
</think>

<summary>
图示粮食安全带的核心廊道在哈尔滨、长春、沈阳三省会城市周边形成绕开城区的避让，体现对城市扩张的隔离意图，但周边预留的缓冲区宽度普遍不足。哈尔滨的西、北侧有粮食安全带环绕，但与城区距离较近（约20-30公里）；长春市西北方向缓冲区较宽，但西侧和西南方向缓冲区宽度不足15公里；沈阳市北部粮食安全带界面完整，但缓冲区宽度仅5-10公里。
综上当前缓冲区预留不足，无法有效抵御城市扩张对优质耕地的侵蚀。可考虑从①优化城市增长边界，即通过卫星城分散产业压力，禁止省会城市向产粮大县方向无序扩展；②修复破碎化区域，利用全域土地整治整合零散地块，选取风险矛盾突出的地块试点"退建还绿"；③建立动态监测机制，利用遥感技术识别"蚕食式"开发趋势，重点监控区域交通轴线沿线、城市潜力扩张方向等高风险区域。
</summary>


### 你的任务:
问题：{question}

""",

    "answer_with_caption_cpt": """你是一位资深城市规划专家。请基于图像内容回答城市规划相关问题。

### 重要:
1. 回答必须基于图片内容和图像描述。
2. 首先观察图片整体内容和布局，分析关键要素，然后结合专业知识回答。
3. 将思考过程放在<think></think>中，将回答放在<summary></summary>中。
4. 思考过程应聚焦问题，采用关键点模式进行思考，整理成"作者提问的是xxx问题，为了解决上述问题我需要思考如下解决该问题的关键点：[1]xxxx, [2]xxxx, [3]xxxx"的格式。
5. 回答应专业、清晰、准确。

### 示例1:
问题： 江苏省的国土空间布局呈现何种特征？
图像描述: 假设存在关于江苏省的国土空间规划图的详细描述

<think>
作者提问的是江苏省国土空间布局特征的问题，为了解决上述问题我需要思考如下解决该问题的关键点：
[1] 图例中各类空间要素的分布特点，包括耕地/永久基本农田（黄色区域）、生态保护红线（绿色区域）、城镇开发边界（红色区域）、水系（蓝色线条）和海域（浅蓝色区域）。
[2] 江苏省城镇开发区的空间分布特征，尤其是南部地区（苏南地区）与北部地区的差异对比，呈现"南密北疏"的特点。
[3] 生态保护红线的分布形态，主要沿江河湖泊呈带状或块状分布，形成集中与分散相结合的空间结构。
</think>

<summary>
布局呈现"南密北疏"特征：南部（如苏锡常都市圈）城镇开发边界密集，北部（如徐州、连云港）相对分散。生态保护红线沿江河湖泊呈带状或块状分布，形成集中与分散相结合的空间结构。
</summary>

### 示例2:
问题： 哈尔滨、长春、沈阳等省会城市周边的粮食安全带是否预留了足够的缓冲区，避免城市扩张侵蚀优质耕地？
图像描述: 假设存在关于江苏省的国土空间规划图的详细描述

<think>
作者提问的是省会城市周边粮食安全带缓冲区是否足够的问题，为了解决上述问题我需要思考如下解决该问题的关键点：
[1] 哈尔滨、长春、沈阳这三个省会城市周边的永久基本农田/粮食安全带分布情况，尤其关注其空间布局形态。
[2] 城市开发边界与粮食安全带之间的缓冲区宽度，包括哈尔滨周边（20-30公里）、长春周边（西北方向较宽，西侧和西南方向不足15公里）、沈阳周边（北部5-10公里）的具体情况。
[3] 根据缓冲区宽度评估其是否足够应对城市扩张压力，判断是否有城市侵蚀优质耕地的风险存在。
[4] 针对缓冲区不足的情况，可能的解决方案，包括优化城市增长边界、修复破碎化区域、建立动态监测机制等。
</think>

<summary>
图示粮食安全带的核心廊道在哈尔滨、长春、沈阳三省会城市周边形成绕开城区的避让，体现对城市扩张的隔离意图，但周边预留的缓冲区宽度普遍不足。哈尔滨的西、北侧有粮食安全带环绕，但与城区距离较近（约20-30公里）；长春市西北方向缓冲区较宽，但西侧和西南方向缓冲区宽度不足15公里；沈阳市北部粮食安全带界面完整，但缓冲区宽度仅5-10公里。
综上当前缓冲区预留不足，无法有效抵御城市扩张对优质耕地的侵蚀。可考虑从①优化城市增长边界，即通过卫星城分散产业压力，禁止省会城市向产粮大县方向无序扩展；②修复破碎化区域，利用全域土地整治整合零散地块，选取风险矛盾突出的地块试点"退建还绿"；③建立动态监测机制，利用遥感技术识别"蚕食式"开发趋势，重点监控区域交通轴线沿线、城市潜力扩张方向等高风险区域。
</summary>


### 你的任务:
问题：{question}
图像描述: {caption}


"""
}







def generate_answers(question_results: List[Dict], 
                     mode: str = "direct", 
                     question_key: str = "question", 
                     include_caption: bool = False) -> List[Dict]:
   
    image_paths = [item["image"] for item in question_results]
    template = "answer_direct_cpt"
    params = [{"question": item[question_key]} for item in question_results]
    results = process_inference(template, image_paths, params, PROMPTS=PROMPTS)
    return results


def gen(image_dir: str = "/HOME/sustc_ghchen/sustc_ghchen_4/planvlmcore/planning_maps_data/images",
         output_path: str = "/HOME/sustc_ghchen/sustc_ghchen_4/planvlmcore/results"):

    
    #     {
    #     "image": "/HOME/sustc_ghchen/sustc_ghchen_4/planvlmcore/results/planning_maps_data/top1000/images/43f2_figure25.jpeg",
    #     "question": "图中绿色区域代表什么功能分区？",
    #     "type": "基础问题1",
    #     "dimension": "图例与地理要素识别"
    #   },

    # data = load_json("/HOME/sustc_ghchen/sustc_ghchen_4/planvlmcore/results/planvlm_sft1/basic_sft.json")
    data = load_json("/HOME/sustc_ghchen/sustc_ghchen_4/planvlmcore/results/question_results_5_13_top1000_answers_cot_merged_wo_type.json")
    data = data
    data_new = generate_answers(data, mode="cpt", include_caption=False)
    for result, item in zip(data_new, data):
        item["response_cpt"] = result
    # save_json(data, os.path.join(output_path, "basic_answers_cot_7k.json"))
    save_json(data, os.path.join(output_path, "question_results_5_13_top1000_answers_cpt_qwen32_long.json"))
    


if __name__ == "__main__":
    fire.Fire(gen)
    

