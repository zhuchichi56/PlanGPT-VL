"""
Prompt Templates for Urban Planning VLM Tasks

This module centralizes all prompt templates used across different tasks.
All prompts are preserved exactly as they were in the original code.
"""

from typing import Dict

# Response Generation Prompts
RESPONSE_PROMPTS = {
    "answer_direct": """你是一个城市规划专家。请观察图片并回答问题：

### 重要:
1. 回答必须基于图片内容。
2. 先观察图片整体内容和布局，分析关键要素，然后结合专业知识回答。
3. 回答应专业、清晰、准确。

问题：{question}""",

    "answer_with_caption": """你是一位资深城市规划专家。请基于图像内容回答城市规划相关问题。

### 重要:
1. 回答必须基于图片内容， 可适当参考图像描述信息。
2. 首先观察图片整体内容和布局，分析关键要素，然后结合专业知识回答。
3. 回答应专业、清晰、准确。
4. 回答模仿如下风格（不参考内容，只参考风格）
eg1. 一圈、两屏、三区、四轴带。\n区包括：\n中部黑土地粮食主产区\n西部草原地农牧片区\n东部山地特色农业片区\n轴带包括：\n哈大先进制造业发展轴 （从哈尔滨到大连的发展轴线）\n开发开放经济带 （包括白城市、松原市等地区）\n长吉图门户发展轴 （从长春到图们江口岸的发展轴线）\n长松大白通长发展环线 （连接长春、松原、大安、白城、通榆等地的发展环线）\n"
eg2. 城镇开发边界与生态保护红线之间通常保持了一定的距离，避免了直接的冲突。然而，在某些区域，城镇开发边界与生态保护红线相邻，存在一定的潜在冲突。具体表现在：\n\n南京、苏州等经济发达地区 ：城镇开发边界与生态保护红线之间的距离较近，尤其是在城市近郊地区，城镇扩张的压力较大，可能会对生态保护红线内的区域产生威胁。\n沿海地区 ：城镇开发边界与海岸带生态保护红线之间的关系尤为重要，需要确保城镇开发不会对海洋生态系统造成破坏。"

问题：{question}
图像描述：{caption}""",

    "answer_direct_cpt": """你是一位资深城市规划专家。请基于图像内容回答城市规划相关问题。

### 重要:
1. 回答必须基于图片内容。
2. 首先观察图片整体内容和布局，分析关键要素，然后结合专业知识回答。
3. 将思考过程放在<think></think>中，将回答放在<summary></summary>中。
4. 思考过程应聚焦问题，采用关键点模式进行思考，整理成"作者提问的是xxx问题，为了解决上述问题我需要思考如下解决该问题的关键点：[1]xxxx, [2]xxxx, [3]xxxx"的格式。
5. 对每一个关键点，需要结合图像和问题写出具体的思考内容。
6. 回答应专业、清晰、准确。

### 示例1:
问题： 江苏省的国土空间布局呈现何种特征？

<think>
作者提问的是江苏省国土空间布局特征的问题，为了解决上述问题我需要思考如下解决该问题的关键点：
[1] 图例中各类空间要素的分布特点，包括耕地/永久基本农田（黄色区域）、生态保护红线（绿色区域）、城镇开发边界（红色区域）、水系（蓝色线条）和海域（浅蓝色区域）。
[2] 江苏省城镇开发区的空间分布特征，尤其是南部地区（苏南地区）与北部地区的差异对比，呈现"南密北疏"的特点。
[3] 生态保护红线的分布形态，主要沿江河湖泊呈带状或块状分布，形成集中与分散相结合的空间结构。
</think>

<summary>
布局呈现"南密北疏"特征：南部（如苏锡常都市圈）城镇开发边界密集，北部（如徐州、连云港）相对分散。生态保护红线沿江河湖泊呈带状或块状分布，形成集中与分散相结合的空间结构。
</summary>

### 示例2:
问题： 哈尔滨、长春、沈阳等省会城市周边的粮食安全带是否预留了足够的缓冲区，避免城市扩张侵蚀优质耕地？

<think>
作者提问的是省会城市周边粮食安全带缓冲区是否足够的问题，为了解决上述问题我需要思考如下解决该问题的关键点：
[1] 哈尔滨、长春、沈阳这三个省会城市周边的永久基本农田/粮食安全带分布情况，尤其关注其空间布局形态。
[2] 城市开发边界与粮食安全带之间的缓冲区宽度，包括哈尔滨周边（20-30公里）、长春周边（西北方向较宽，西侧和西南方向不足15公里）、沈阳周边（北部5-10公里）的具体情况。
[3] 根据缓冲区宽度评估其是否足够应对城市扩张压力，判断是否有城市侵蚀优质耕地的风险存在。
[4] 针对缓冲区不足的情况，可能的解决方案，包括优化城市增长边界、修复破碎化区域、建立动态监测机制等。
</think>

<summary>
图示粮食安全带的核心廊道在哈尔滨、长春、沈阳三省会城市周边形成绕开城区的避让，体现对城市扩张的隔离意图，但周边预留的缓冲区宽度普遍不足。哈尔滨的西、北侧有粮食安全带环绕，但与城区距离较近（约20-30公里）；长春市西北方向缓冲区较宽，但西侧和西南方向缓冲区宽度不足15公里；沈阳市北部粮食安全带界面完整，但缓冲区宽度仅5-10公里。
综上当前缓冲区预留不足，无法有效抵御城市扩张对优质耕地的侵蚀。可考虑从①优化城市增长边界，即通过卫星城分散产业压力，禁止省会城市向产粮大县方向无序扩展；②修复破碎化区域，利用全域土地整治整合零散地块，选取风险矛盾突出的地块试点"退建还绿"；③建立动态监测机制，利用遥感技术识别"蚕食式"开发趋势，重点监控区域交通轴线沿线、城市潜力扩张方向等高风险区域。
</summary>


### 你的任务:
问题：{question}

""",

    "answer_with_caption_cpt": """你是一位资深城市规划专家。请基于图像内容回答城市规划相关问题。

### 重要:
1. 回答必须基于图片内容和图像描述。
2. 首先观察图片整体内容和布局，分析关键要素，然后结合专业知识回答。
3. 将思考过程放在<think></think>中，将回答放在<summary></summary>中。
4. 思考过程应聚焦问题，采用关键点模式进行思考，整理成"作者提问的是xxx问题，为了解决上述问题我需要思考如下解决该问题的关键点：[1]xxxx, [2]xxxx, [3]xxxx"的格式。
5. 回答应专业、清晰、准确。

### 示例1:
问题： 江苏省的国土空间布局呈现何种特征？
图像描述: 假设存在关于江苏省的国土空间规划图的详细描述

<think>
作者提问的是江苏省国土空间布局特征的问题，为了解决上述问题我需要思考如下解决该问题的关键点：
[1] 图例中各类空间要素的分布特点，包括耕地/永久基本农田（黄色区域）、生态保护红线（绿色区域）、城镇开发边界（红色区域）、水系（蓝色线条）和海域（浅蓝色区域）。
[2] 江苏省城镇开发区的空间分布特征，尤其是南部地区（苏南地区）与北部地区的差异对比，呈现"南密北疏"的特点。
[3] 生态保护红线的分布形态，主要沿江河湖泊呈带状或块状分布，形成集中与分散相结合的空间结构。
</think>

<summary>
布局呈现"南密北疏"特征：南部（如苏锡常都市圈）城镇开发边界密集，北部（如徐州、连云港）相对分散。生态保护红线沿江河湖泊呈带状或块状分布，形成集中与分散相结合的空间结构。
</summary>

### 示例2:
问题： 哈尔滨、长春、沈阳等省会城市周边的粮食安全带是否预留了足够的缓冲区，避免城市扩张侵蚀优质耕地？
图像描述: 假设存在关于江苏省的国土空间规划图的详细描述

<think>
作者提问的是省会城市周边粮食安全带缓冲区是否足够的问题，为了解决上述问题我需要思考如下解决该问题的关键点：
[1] 哈尔滨、长春、沈阳这三个省会城市周边的永久基本农田/粮食安全带分布情况，尤其关注其空间布局形态。
[2] 城市开发边界与粮食安全带之间的缓冲区宽度，包括哈尔滨周边（20-30公里）、长春周边（西北方向较宽，西侧和西南方向不足15公里）、沈阳周边（北部5-10公里）的具体情况。
[3] 根据缓冲区宽度评估其是否足够应对城市扩张压力，判断是否有城市侵蚀优质耕地的风险存在。
[4] 针对缓冲区不足的情况，可能的解决方案，包括优化城市增长边界、修复破碎化区域、建立动态监测机制等。
</think>

<summary>
图示粮食安全带的核心廊道在哈尔滨、长春、沈阳三省会城市周边形成绕开城区的避让，体现对城市扩张的隔离意图，但周边预留的缓冲区宽度普遍不足。哈尔滨的西、北侧有粮食安全带环绕，但与城区距离较近（约20-30公里）；长春市西北方向缓冲区较宽，但西侧和西南方向缓冲区宽度不足15公里；沈阳市北部粮食安全带界面完整，但缓冲区宽度仅5-10公里。
综上当前缓冲区预留不足，无法有效抵御城市扩张对优质耕地的侵蚀。可考虑从①优化城市增长边界，即通过卫星城分散产业压力，禁止省会城市向产粮大县方向无序扩展；②修复破碎化区域，利用全域土地整治整合零散地块，选取风险矛盾突出的地块试点"退建还绿"；③建立动态监测机制，利用遥感技术识别"蚕食式"开发趋势，重点监控区域交通轴线沿线、城市潜力扩张方向等高风险区域。
</summary>


### 你的任务:
问题：{question}
图像描述: {caption}


"""
}

# Question Generation Prompts
QUESTION_PROMPTS = {
    "context_question_generation_od": """你是一个城市规划师，请观察图片并结合提供的文本上下文提出10个问题：

### 重要:
1. 问题必须基于图片和上下文信息。
2. 从以下15个城市规划维度中任选多个维度，确保问题多样化且专业。
3. 包含7个基础问题（直接从图像可获得答案）和3个扩展延伸问题（需要更深入思考）。
4. 问题长度由短到长，难度由易到难。
5. 必须包含关于空间方位和图例颜色的问题。
6. 把思考过程放在<think></think>中，把问题放在<summary></summary>中。
7. 每个问题前标明是基础问题还是扩展问题，以及从哪个维度提出的。

### 15个城市规划问题维度及示例：

## 1. 图纸类型识别
- 示例："根据图纸的表达风格和内容，判断这是什么类型的规划图？"
- 示例："这张图属于城市总体规划还是详细规划的范畴？"

## 2. 空间关系识别与分析
- 示例："图中主城区与卫星城之间的空间距离如何？"
- 示例："从位置关系看，主要生态区与工业区之间有什么缓冲带？"

## 3. 图例与地理要素识别
- 示例："图中红色区域代表什么功能分区？"
- 示例："图中蓝色线条表示哪些水系要素？"

## 4. 规划方案问题识别与分析
- 示例："规划中工业区紧邻住宅区可能带来哪些问题？"
- 示例："从土地利用效率看，规划方案存在哪些不足？"

## 5. 规划要素描述与定位
- 示例："主要商业中心位于规划区的哪个部分？"
- 示例："图中的水源保护区主要分布在哪些区域？"

## 6. 城市功能区分析
- 示例："不同功能区之间如何实现有效衔接？"
- 示例："城市核心区的功能定位与整体规划目标是否协调？"

## 7. 交通系统规划分析
- 示例:"主要交通干道的走向是怎样的？"
- 示例："交通枢纽与各功能区的可达性如何？"

## 8. 生态环境保护规划分析
- 示例："生态廊道在规划中的分布格局是什么？"
- 示例："规划如何保障区域生态系统的完整性？"

## 9. 规划政策与战略关联
- 示例："这份规划反映了哪些国家层面的发展战略？"
- 示例："如何从规划中看出区域协同发展的考量？"

## 10. 历史文化保护与利用
- 示例："历史保护区在城市空间中如何布局？"
- 示例："文化资源保护与城市更新如何平衡？"

## 11. 地图要素识别
- 示例："图中的比例尺和指北针位于何处？"
- 示例："规划图的图例框包含哪些主要元素？"

## 12. 规划图标题推断
- 示例："根据内容，这张图的主题可能是什么？"
- 示例："图中强调的要素表明这是什么性质的规划图？"

## 13. 规划结构分析
- 示例："城市结构是单中心还是多中心模式？"
- 示例："规划中有几条主要发展轴和发展带？"

## 14. 规划影响评估
- 示例："规划实施后可能对区域生态带来什么影响？"
- 示例："这一规划对区域经济格局有何改变作用？"

## 15. 发展协调与平衡分析
- 示例："规划如何处理开发与保护的矛盾？"
- 示例："城市扩张与农田保护如何在规划中取得平衡？"

### 输出格式示例：

<think>
我正在分析一张城市规划图，需要从不同角度提出问题。从图中我观察到以下要素：

基本信息：
- 这是一张覆盖某省域范围的空间规划图
- 图例使用了多种颜色：绿色表示生态保护区域，红色表示城镇建设区，黄色表示农业区
- 有清晰的河流和湖泊系统，呈蓝色
- 有标注的主要城市和重点区域
- 图中存在多条交通线路连接各个中心

空间关系：
- 北部地区以山地为主，多为绿色生态区
- 中部和东部是平原区，以农业和城镇为主
- 南部有大型水体和沿海城市群
- 几个主要城市形成了发展轴带

我将分层次提问：
基础问题(7个)：
- 从图例识别角度：图中颜色含义
- 从地图要素识别角度：指北针和比例尺
- 从空间关系角度：主要城市位置
- 从规划要素描述角度：水系分布
- 从交通系统角度：主要交通廊道
- 从图纸类型识别角度：规划图类型
- 从规划结构分析角度：发展轴和区域数量

扩展问题(3个)：
- 从规划政策角度：与国家战略的关联
- 从生态环境保护角度：生态系统完整性
- 从发展协调与平衡角度：城乡协调发展
</think>

<summary>
【基础问题1】[图例与地理要素识别] 图中绿色、红色和黄色分别代表什么功能区域？

【基础问题2】[地图要素识别] 规划图的指北针位于哪个位置？

【基础问题3】[空间关系识别] 主要城市群分布在规划区的哪个方位？

【基础问题4】[规划要素描述] 图中的主要水系如何分布？

【基础问题5】[交通系统规划] 规划中的主要交通廊道连接了哪些重要节点？

【基础问题6】[图纸类型识别] 根据表达内容和范围，这属于哪种类型的规划图？

【基础问题7】[规划结构分析] 规划区内有几个主要发展轴和功能分区？它们的空间布局特点是什么？

【扩展问题8】[规划政策与战略关联] 从规划的空间布局来看，这份规划如何回应国家关于区域协调发展的战略要求？

【扩展问题9】[生态环境保护规划分析] 规划中的生态保护区域构成了怎样的网络系统？这种布局对维护区域生态安全具有什么作用？

【扩展问题10】[发展协调与平衡分析] 规划中如何处理城镇开发边界扩张与永久基本农田保护之间的潜在冲突？城乡融合发展的思路体现在哪些空间安排上？
</summary>
"""
}

# Critical Point Thinking Prompts
CPT_PROMPTS = {
    "critical_version": """作为城市规划专家，请根据已有的图片，问题和回答，提取解决该问题的关键思考点。

问题：{question}

回答：{answer}

请按照以下格式输出：
<thinking>
[1] (描述第一个关键思考点，需具体解释图中的规划要素如何支持这一思考)
[2] (描述第二个关键思考点，需具体解释图中的规划要素如何支持这一思考)
[3] (描述第三个关键思考点，需具体解释图中的规划要素如何支持这一思考)
[4] (如有必要，描述第四个关键思考点)
[5] (如有必要，描述第五个关键思考点)
</thinking>
"""
}

# Caption Generation Prompts (for RLAIF-V)
CAPTION_PROMPTS = {
    "caption_generation": """请作为城市规划专家，

请提供一个详细的图像描述，遵循以下格式：
[1] 第一个关键点（颜色、区域、分布等）
[2] 第二个关键点（其他规划特征）
[3] 第三个关键点（空间关系）
...

请确保每个关键点都编号并分段，尽可能详细描述图中所见的规划要素，特别是与问题相关的部分。""",

    "caption_improvement": """请评估并改进以下关于规划图的描述点，该描述点是为了回答问题："{question}"

以下是现有的描述点 [#{index}]：
"{key_point}"

请评估此描述点的准确性和完整性，并给出改进建议：
1. 描述是否准确？如果不准确，指出错误之处。
2. 描述是否完整？是否遗漏了重要信息？
3. 描述与问题的相关性如何？是否需要添加更多与问题直接相关的内容？

如果描述已经很好且无需改进，请回复"无需改进"。否则，请提供一个改进的版本，保持相似的长度和风格。

你应该按照如下格式回复：
改进版本：
改进的描述点：
建议修改为：
"""
}

# Filter Prompts
FILTER_PROMPTS = {
    "planning_map_filter": """你是城市规划专家。请判断下面图像是否为"完整且独立的城市或国土空间规划图"。

请先对图像做一个简要描述，然后判断它是否为规划图。

判断标准：
1. 必须是完整的规划图，而非规划图的一部分或截图
2. 规划图应作为图像的主要内容，占据图像的主要区域
3. 不应包含大量与规划图无关的其他页面元素（如大段文字说明、表格等）
4. 应具备规划图的典型特征：
   - 清晰的空间布局或土地分区的视觉结构
   - 图例、比例尺、方向标、图名、规划单位等规划图必要元素

请注意：
- 如果图像是整页文档的扫描件，且规划图只是页面的一部分，应判定为不符合要求
- 如果图像包含多张规划图，也应判定为不符合要求
- 如果图像内容模糊不清，难以辨认规划内容，应判定为不符合要求

图像分析后，请按以下格式输出:

分析：[在这里提供您的分析]
判断：如果是完整且独立的规划图，请输出：\\boxed{1}
如果不是完整且独立的规划图，请输出：\\boxed{0}
"""
}

# Combine all prompts
PROMPTS = {
    **RESPONSE_PROMPTS,
    **QUESTION_PROMPTS,
    **CPT_PROMPTS,
    **CAPTION_PROMPTS,
    **FILTER_PROMPTS
}


class PromptManager:
    """Manager for accessing and formatting prompts"""

    def __init__(self, prompts: Dict[str, str] = None):
        self.prompts = prompts or PROMPTS

    def get(self, key: str, **kwargs) -> str:
        """
        Get a prompt by key and format with kwargs

        Args:
            key: Prompt key
            **kwargs: Format arguments

        Returns:
            Formatted prompt string
        """
        template = self.prompts.get(key)
        if template is None:
            raise KeyError(f"Prompt key '{key}' not found")

        if kwargs:
            return template.format(**kwargs)
        return template

    def add(self, key: str, template: str):
        """Add a new prompt template"""
        self.prompts[key] = template

    def list_keys(self) -> list:
        """List all available prompt keys"""
        return list(self.prompts.keys())
